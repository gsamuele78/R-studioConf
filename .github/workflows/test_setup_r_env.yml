name: Test r_env setup (Comprehensive)

on:
  push:
    paths:
      - 'r_env_manager.sh'
      - 'setup_r_env.sh'
      - 'scripts/**'
      - '.github/workflows/test_setup_r_env.yml'
  pull_request:
    paths:
      - 'r_env_manager.sh'
      - 'setup_r_env.sh'
      - 'scripts/**'
      - '.github/workflows/test_setup_r_env.yml'
  workflow_dispatch:
  schedule:
    - cron: '30 2 * * *' # Run at 02:30 UTC every day (Nightly)

jobs:
  test-script:
    runs-on: ubuntu-24.04
    timeout-minutes: 60
    container:
      image: ubuntu:24.04
      options: --user root

    steps:
      - name: Install required packages
        run: |
          set -euo pipefail
          apt-get update -y
          apt-get install -y --no-install-recommends \
            sudo \
            git \
            curl \
            ca-certificates \
            lsb-release \
            wget \
            gdebi-core \
            apt-transport-https \
            gnupg2 \
            shellcheck \
            net-tools \
            iputils-ping \
            dbus \
            apt-utils \
            openssh-client
          # Provide minimal systemd marker for scripts that expect it in containers
          if [ ! -d /run/systemd ]; then mkdir -p /run/systemd; fi
          if [ ! -f /run/systemd/container ]; then echo 'container' > /run/systemd/container; fi
          apt-get clean
          rm -rf /var/lib/apt/lists/*

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show runner info
        run: |
          echo "--- System Info ---"
          uname -a
          lsb_release -a || cat /etc/os-release
          echo "--- Disk Usage ---"
          df -h
          echo "--- Memory Usage ---"
          free -h
          echo "--- User Info ---"
          echo "User: $(whoami)"
          echo "Sudo version: $(sudo --version || echo 'sudo not found')"
          echo "Systemctl path: $(which systemctl || echo 'systemctl not found')"
          echo "dbus daemon path: $(which dbus-daemon || echo 'dbus-daemon not found')"

      - name: Make scripts executable (if present)
        run: |
          chmod +x ./r_env_manager.sh || true
          chmod +x ./setup_r_env.sh || true

      - name: Lint with ShellCheck
        run: |
          shellcheck ./r_env_manager.sh || true
          shellcheck ./setup_r_env.sh || true

      - name: Test pre-flight checks
        run: |
          if [ -x ./r_env_manager.sh ]; then
            ./r_env_manager.sh pre_flight_checks || true
          elif [ -x ./setup_r_env.sh ]; then
            ./setup_r_env.sh fn_pre_flight_checks || true
          else
            echo "No r_env_manager.sh or setup_r_env.sh present - skipping pre-flight checks"
          fi

      - name: Test add CRAN repo
        run: |
          if [ -x ./r_env_manager.sh ]; then
            ./r_env_manager.sh setup_cran_repo || true
          elif [ -x ./setup_r_env.sh ]; then
            ./setup_r_env.sh fn_add_cran_repo || true
          else
            echo "No r_env_manager.sh or setup_r_env.sh present - skipping setup_cran_repo"
          fi

      - name: Test install R
        run: |
          if [ -x ./r_env_manager.sh ]; then
            ./r_env_manager.sh install_r || true
          elif [ -x ./setup_r_env.sh ]; then
            ./setup_r_env.sh fn_install_r || true
          else
            echo "No r_env_manager.sh or setup_r_env.sh present - skipping install_r"
          fi

      - name: Test install OpenBLAS/OpenMP
        run: |
          if [ -x ./r_env_manager.sh ]; then
            ./r_env_manager.sh install_openblas_openmp || true
          elif [ -x ./setup_r_env.sh ]; then
            ./setup_r_env.sh fn_install_openblas || true
          else
            echo "No r_env_manager.sh or setup_r_env.sh present - skipping install_openblas_openmp"
          fi

      - name: Test verify OpenBLAS/OpenMP with R
        run: |
          if [ -x ./r_env_manager.sh ]; then
            ./r_env_manager.sh verify_openblas_openmp || true
          elif [ -x ./setup_r_env.sh ]; then
            ./setup_r_env.sh fn_verify_openblas || true
          else
            echo "No r_env_manager.sh or setup_r_env.sh present - skipping verify_openblas_openmp"
          fi

      - name: Test setup bspm
        run: |
          if [ -x ./r_env_manager.sh ]; then
            ./r_env_manager.sh setup_bspm || true
          elif [ -x ./setup_r_env.sh ]; then
            ./setup_r_env.sh fn_setup_bspm || true
          else
            echo "No r_env_manager.sh or setup_r_env.sh present - skipping setup_bspm"
          fi

      - name: Test install core R dev & user packages
        env:
          GITHUB_PAT: ${{ secrets.GH_PAT_FOR_R_PACKAGES }}
        run: |
          if [ -x ./r_env_manager.sh ]; then
            ./r_env_manager.sh install_core_r_dev_pkgs || true
            ./r_env_manager.sh install_user_cran_pkgs || true
            ./r_env_manager.sh install_user_github_pkgs || true
          elif [ -x ./setup_r_env.sh ]; then
            ./setup_r_env.sh fn_install_r_packages || true
          else
            echo "No r_env_manager.sh or setup_r_env.sh present - skipping R package installation"
          fi

      - name: Test install RStudio Server
        run: |
          if [ -x ./r_env_manager.sh ]; then
            ./r_env_manager.sh install_rstudio_server || true
          elif [ -x ./setup_r_env.sh ]; then
            ./setup_r_env.sh fn_install_rstudio_server || true
          else
            echo "No r_env_manager.sh or setup_r_env.sh present - skipping install_rstudio_server"
          fi

      - name: Verify R installation
        run: |
          R --version || true
          Rscript --version || true
          Rscript -e "sessionInfo()" || true

      - name: Verify CRAN/BSPM packages are installed
        run: |
          Rscript -e "pkgs <- c('terra','raster','sf','dismo','spThin','tidyverse','bspm'); res <- sapply(pkgs, requireNamespace, quietly=TRUE); print(res); if(!all(res)) { warning('One or more expected packages are not available: ', paste(names(res)[!res], collapse=', ')); }" || true

      - name: Verify devtools & GitHub packages
        run: |
          Rscript -e "if (!requireNamespace('devtools', quietly=TRUE)) warning('devtools not installed')" || true
          Rscript -e "if (!requireNamespace('transformeR', quietly=TRUE)) warning('transformeR not installed from GitHub. Check GITHUB_PAT and package availability.')" || true

      - name: Verify RStudio Server installation
        run: |
          systemctl status rstudio-server || echo "systemctl status rstudio-server failed (may be expected in container)"
          which rstudio-server || true
          rstudio-server version || true

      - name: Test uninstall (cleanup)
        run: |
          if [ -x ./r_env_manager.sh ]; then
            LOG_LEVEL=DEBUG ./r_env_manager.sh uninstall || true
          elif [ -x ./setup_r_env.sh ]; then
            LOG_LEVEL=DEBUG ./setup_r_env.sh uninstall_all || true
          else
            echo "No r_env_manager.sh or setup_r_env.sh present - skipping uninstall"
          fi

      - name: Confirm removal of R, RStudio, packages (best-effort)
        run: |
          ! command -v R || { echo "R still found!"; exit 0; } || true
          ! command -v rstudio-server || { echo "RStudio Server still found!"; exit 0; } || true

      - name: Re-run uninstall (idempotency)
        run: |
          if [ -x ./r_env_manager.sh ]; then
            LOG_LEVEL=DEBUG ./r_env_manager.sh uninstall || true
          elif [ -x ./setup_r_env.sh ]; then
            LOG_LEVEL=DEBUG ./setup_r_env.sh uninstall_all || true
          else
            echo "No r_env_manager.sh or setup_r_env.sh present - skipping re-run uninstall"
          fi

      - name: Archive installation logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: r_setup_logs_${{ github.run_id }}
          path: /var/log/r_setup/
          if-no-files-found: ignore

      - name: Show main log tail
        if: always()
        run: |
          if ls /var/log/r_setup/r_setup_*.log 1> /dev/null 2>&1; then
            tail -n 100 /var/log/r_setup/r_setup_*.log
          else
            echo "No r_setup logs found in /var/log/r_setup/"
          fi

      - name: Test bad argument handling
        run: |
          if [ -x ./r_env_manager.sh ]; then
            ! ./r_env_manager.sh not_a_real_action || true
          elif [ -x ./setup_r_env.sh ]; then
            ! ./setup_r_env.sh not_a_real_action || true
          else
            echo "No r_env_manager.sh or setup_r_env.sh present - skipping bad-arg test"
          fi

      - name: Test script as non-root (should fail gracefully)
        run: |
          set +e
          id -u nobody >/dev/null 2>&1 || useradd nobody
          if [ -x ./r_env_manager.sh ]; then
            output=$(su -s /bin/bash -c "./r_env_manager.sh install_r" nobody 2>&1 || true)
          elif [ -x ./setup_r_env.sh ]; then
            output=$(su -s /bin/bash -c "./setup_r_env.sh fn_install_r" nobody 2>&1 || true)
          else
            output="No r_env_manager.sh or setup_r_env.sh present - nothing to run as non-root"
          fi
          echo "Output from non-root execution:"
          echo "${output}"
          set -e

      - name: Menu/help/usage output
        run: |
          ./r_env_manager.sh || ./setup_r_env.sh || true
