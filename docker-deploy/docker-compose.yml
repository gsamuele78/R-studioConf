version: '3.8'

services:
  # --- RStudio Service (SSSD Backend) ---
  rstudio-sssd:
    profiles: [ "sssd" ]
    build:
      context: .
      dockerfile: Dockerfile.sssd
    image: rstudio-botanical-sssd:latest
    container_name: rstudio_pet
    restart: unless-stopped
    network_mode: "host"
    environment:
      - AUTH_BACKEND=sssd
      - USERID=1000
      - GROUPID=1000
    volumes:
      - ${HOST_HOME_DIR}:/home
      - ${HOST_PROJECT_ROOT}:/nfs/home
      - /var/lib/sss/pipes:/var/lib/sss/pipes:rw
      - /var/lib/sss/mc:/var/lib/sss/mc:ro
      - /etc/sssd/sssd.conf:/etc/sssd/sssd.conf:ro
      - /etc/krb5.conf:/etc/krb5.conf:ro
      - /etc/nsswitch.conf:/etc/nsswitch.conf:ro

  # --- RStudio Service (Samba Backend) ---
  rstudio-samba:
    profiles: [ "samba" ]
    build:
      context: .
      dockerfile: Dockerfile.samba
    image: rstudio-botanical-samba:latest
    container_name: rstudio_pet
    restart: unless-stopped
    network_mode: "host"
    environment:
      - AUTH_BACKEND=samba
    volumes:
      - ${HOST_HOME_DIR}:/home
      - ${HOST_PROJECT_ROOT}:/nfs/home
      - /var/run/samba/winbindd:/var/run/samba/winbindd:rw
      - /var/lib/samba:/var/lib/samba:rw
      - /etc/samba/smb.conf:/etc/samba/smb.conf:ro
      - /etc/krb5.conf:/etc/krb5.conf:ro
      - /etc/nsswitch.conf:/etc/nsswitch.conf:ro

  # --- Nginx Portal Service ---
  nginx-portal:
    profiles: [ "portal" ]
    build:
      context: .
      dockerfile: Dockerfile.nginx
    image: botanical-portal-nginx:latest
    container_name: nginx_portal
    network_mode: "host"
    volumes:
      # Mount assets and templates to context paths if dev changes needed
      # But Dockerfile copies them in. We might want read-only mounts for live updates?
      # Let's rely on Image build for stability as per "Pet" design.
      # Just mount SSL.
      - ${SSL_CERT_PATH}:/etc/ssl/certs/server.crt:ro
      - ${SSL_KEY_PATH}:/etc/ssl/private/server.key:ro
    environment:
      - NGINX_HOST=${HOST_DOMAIN}
      - NGINX_PORT=${HTTPS_PORT}
      - RSTUDIO_PORT=${RSTUDIO_PORT}
