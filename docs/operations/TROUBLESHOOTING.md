# Troubleshooting & Operations

## 1. Common Issues

### 1.1 RStudio Login Loop / "Signed Out"

- **Symptoms**: You log in via portal, click tile, but RStudio says "Signed Out".
- **Cause**: The Session Cookies (`AWSALB`, `user-id`) are not being shared with the new tab.
- **Fix**:
  - Verify `rserver.conf` has `www-enable-origin-check=1`.
  - Verify Nginx config passes `proxy_pass_header Set-Cookie;`.
  - **Critical**: Ensure you are using `https://`. Cookies with `Secure` flag are dropped on HTTP.

### 1.2 "Quirks Mode" Warning (Console)

- **Symptoms**: Browser console shows "This page is in Quirks Mode" pointing to `line 9 > injectedScript`.
- **Analysis**: This is a **False Positive** caused by browser extensions (LastPass, AdBlock) injecting code into the 404 page generated by RStudio when a bad URL is requested.
- **Action**: Ignore. The Portal templates use `<!DOCTYPE html>` and render in Standards Mode.

### 1.3 Web Terminal "Forbidden" (403)

- **Symptoms**: Terminal tile opens, but shows "403 Forbidden" or "Authentication Failed".
- **Cause**: The credentials passed in the URL `user:pass@host` were rejected by `auth_pam`.
- **Fix**:
  - Check system logs: `tail -f /var/log/auth.log`.
  - Verify the user exists in AD or `/etc/shadow`.
  - Verify `nginx` user has read access to `/etc/shadow` (if using local auth via `shadow` group).

### 1.4 Nextcloud "Corrupted Content" / CSS Fail

- **Symptoms**: Nextcloud loads but looks broken (no CSS, raw HTML).
- **Cause**: You are accessing the Backend IP directly (`https://172.x.x.x/files-inner`).
- **Fix**: You **MUST** use the Proxy URL (`https://PUBLIC_IP/files-inner/`). Nginx handles the path rewriting required for Nextcloud to find its CSS files.

---

## 2. Logs & Diagnostics

| Component | Log Location | Purpose |
| :--- | :--- | :--- |
| **Nginx Access** | `/var/log/nginx/access.log` | See incoming requests, 404s, 500s. |
| **Nginx Error** | `/var/log/nginx/error.log` | Config errors, PAM auth failures. |
| **RStudio** | `/var/log/rstudio-server/rserver.log` | Session startup errors, license issues. |
| **TTYD** | `journalctl -u ttyd` | Terminal startup, websocket errors. |
| **Portal** | Browser Console (F12) | Frontend logic logs ("Auth Sequence..."). |

## 3. Maintenance

### Certificates

SSL Certificates are handled by `scripts/32_setup_letsencrypt.sh`.
Renewal is automatic via Certbot, but verify manually:

```bash
sudo certbot renew --dry-run
```

### Updates

To update system packages:

```bash
sudo apt update && sudo apt upgrade -y
# Restart services if core libs updated
sudo systemctl restart nginx rstudio-server
```
