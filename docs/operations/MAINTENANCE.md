# Operations & Maintenance Guide

## 1. Routine Updates

### 1.1 Operating System

Standard `apt` updates are safe.

```bash
sudo apt update
sudo apt upgrade -y
```

**Impact**:

- **Nginx**: Will restart automatically.
- **RStudio**: Will restart automatically. User sessions *might* persist if configured (default yes).
- **TTYD**: Service restart kills active terminals.

### 1.2 R Environment

To update R packages:

```bash
sudo R
> update.packages(ask=FALSE)
```

To update R version itself:
Running `./r_env_manager.sh` will check for new versions if configured.

## 2. Certificate Management

### 2.1 Let's Encrypt

Certbot handles auto-renewal via systemd timer (`certbot.timer`).
To verify:

```bash
sudo systemctl status certbot.timer
sudo certbot renew --dry-run
```

### 2.2 Self-Signed

Certificates generated by the script expire in 365 days.
To renew:

1. Run `./scripts/30_install_nginx.sh`.
2. Select "Install/Configure".
3. The script detects existing cert but you can choose to overwrite/regenerate.

## 3. Logs & Auditing

### 3.1 Centralized Logging

Logs are split by service.

- **Nginx Access**: `/var/log/nginx/access.log`
- **Nginx Error**: `/var/log/nginx/error.log` (Auth failures here).
- **System Auth**: `/var/log/auth.log` (PAM/SSSD details).
- **RStudio**: `journalctl -u rstudio-server`.

### 3.2 Troubleshooting a "Down" Service

If the Portal loads but a tile spins forever:

1. Check Process: `pgrep -a rstudio-server` or `pgrep ttyd`.
2. Check Port binding: `ss -tulnp | grep 8787` (RStudio) or `7681` (TTYD).
3. Restart Service: `sudo systemctl restart rstudio-server`.

## 4. Backup & Restore

### 4.1 Configuration

The `r_env_manager.sh` script automatically backs up any config file it touches to `/var/backups/r_env_manager/`.
To restore:

1. Locate file in `backups/`.
2. Copy back to original location.

    ```bash
    cp /var/backups/r_env_manager/files/etc/rstudio/rserver.conf.2025... /etc/rstudio/rserver.conf
    ```

### 4.2 User Data

User home directories (`/home/DOMAIN/user`) are NOT backed up by these scripts. Use standard backup tools (rsync, backuppc) for `/home`.
