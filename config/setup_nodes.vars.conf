#!/bin/bash
# ----------------------------------------------------------------
# SETUP NODES VARS (v1.0)
# ----------------------------------------------------------------
# Configuration for 50_setup_nodes.sh
# This script deploys OpenBLAS/CORETYPE detection, Rprofile.site v9.3.x,
# the R audit script, kernel tuning, and optional Ollama AI service.

# =============================================================================
# INFRASTRUCTURE
# =============================================================================

# The hostname shown in the Rprofile welcome banner and log files.
# Auto-detected at runtime if left empty.
BIOME_HOST=""

# IP used for info display (auto-detected from hostname -I if empty).
BIOME_IP=""

# NFS home directory root (where AD users' homes live)
NFS_HOME="/nfs/home"

# CIFS/SMB archive mount point
CIFS_ARCHIVE="/mnt/ProjectStorage"

# Python geospatial virtualenv path (created/updated by setup)
PYTHON_ENV="/opt/r-geospatial"

# RAMDisk size on /tmp (e.g. 100G, 20G — must be < physical RAM)
RAMDISK_SIZE="100G"
RAMDISK_GB=100

# Name of the biome-calc config directory (stores audit.conf, ai_model, etc.)
BIOME_CONF="/etc/biome-calc"

# System log file (world-writable so AD rsession users can write to it)
LOG_FILE="/var/log/r_biome_system.log"

# =============================================================================
# RPROFILE & R CONFIGURATION
# =============================================================================

# Number of vCores visible to the VM (shown in Rprofile's welcome banner)
VM_VCORES=32

# Total RAM available to the VM in GB (net of OS overhead — shown in welcome)
VM_RAM_GB=400

# RStudio session configuration (read by Rprofile to determine cleanup timeout)
RSESSION_CONF_PATH="/etc/rstudio/rsession.conf"

# =============================================================================
# OPENBLAS / BLAS TUNING
# =============================================================================

# Maximum OpenBLAS/OMP thread cap to prevent QEMU livelock
# This is also enforced in Rprofile.site dynamically.
MAX_BLAS_THREADS=16
# Alias used by the audit template (%%MAX_THREADS%%)
MAX_THREADS=16

# Path to OpenBLAS pthread BLAS alternative
OPENBLAS_BLAS_PATH="/usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3"
OPENBLAS_LAPACK_PATH="/usr/lib/x86_64-linux-gnu/openblas-pthread/liblapack.so.3"

# =============================================================================
# OLLAMA AI SERVICE
# =============================================================================

# Set to "true" to skip Ollama installation/setup
SKIP_OLLAMA=false

# Base model for AI assistant (8-bit quant: best quality; 4-bit: less RAM)
OLLAMA_BASE_MODEL="qwen2.5-coder:14b-instruct-q4_K_M"

# Fallback model if the base model cannot be pulled
OLLAMA_FALLBACK_MODEL="codellama:7b"

# Name of the custom R-focused model created from the Modelfile
OLLAMA_CUSTOM_MODEL="r-coder"

# Maximum RAM for the Ollama systemd service (cgroup MemoryMax)
OLLAMA_RAM_LIMIT="24G"

# Number of inference threads (roughly half of vCores, leaves rest for R)
OLLAMA_THREADS=24

# =============================================================================
# PYTHON PACKAGES (for geospatial venv)
# =============================================================================

# Python packages installed into PYTHON_ENV
PYTHON_PACKAGES=(
    "earthengine-api"
    "numpy<2"
    "pandas"
    "tensorflow>=2.16"
    "tf-keras"
)

# =============================================================================
# R PACKAGES
# =============================================================================

# R packages installed via bspm/CRAN during setup
R_PACKAGES=(
    "data.table"
    "arrow"
    "dplyr"
    "tidyr"
    "future"
    "future.apply"
    "parallelly"
    "terra"
    "sf"
    "rgee"
    "tensorflow"
    "keras"
    "reticulate"
    "unix"
    "sessioninfo"
    "RhpcBLASctl"
    "chattr"
    "jsonlite"
)

# =============================================================================
# CONTACT / BRANDING
# =============================================================================

# Contact email shown in Rprofile welcome and audit reports
BIOME_CONTACT="Lifewatch_Biome_internal@live.unibo.it"

# Rprofile version label (shown in welcome banner and status())
RPROFILE_VERSION="9.3"
