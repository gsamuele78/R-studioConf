#!/bin/bash
# ----------------------------------------------------------------
# NGINX SETUP VARS (v2.2 - Unified Config)
# ----------------------------------------------------------------
# This config sources common AD/Kerberos settings from lib_kerberos_setup.vars.conf
# and backend-specific settings from join_domain_sssd/samba.vars.conf

# =============================================================================
# Source Common AD/Kerberos Configuration
# =============================================================================
_CONF_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" &>/dev/null && pwd)"

# Source common Kerberos config (provides DEFAULT_AD_DOMAIN_*, DEFAULT_SIMPLE_ALLOW_GROUPS, etc.)
if [[ -f "${_CONF_DIR}/lib_kerberos_setup.vars.conf" ]]; then
    # shellcheck source=lib_kerberos_setup.vars.conf
    source "${_CONF_DIR}/lib_kerberos_setup.vars.conf"
fi

# Source SSSD config if available (provides SSSD-specific variables)
if [[ -f "${_CONF_DIR}/join_domain_sssd.vars.conf" ]]; then
    source "${_CONF_DIR}/join_domain_sssd.vars.conf"
fi

# Source Samba config if available (provides Samba-specific variables)
if [[ -f "${_CONF_DIR}/join_domain_samba.vars.conf" ]]; then
    source "${_CONF_DIR}/join_domain_samba.vars.conf"
fi

# =============================================================================
# NGINX-SPECIFIC CONFIGURATION
# =============================================================================

# --- Certificate Mode ---
# Valid options: "SELF_SIGNED" or "LETS_ENCRYPT"
CERT_MODE="SELF_SIGNED"

# --- Domain and Paths ---
# Primary domain or IP address for the server
DOMAIN_OR_IP="your_domain_or_ip"
# Base directory for Nginx configurations
NGINX_DIR="/etc/nginx"
# Directory to store generated template snippets
NGINX_TEMPLATE_DIR="/etc/nginx/templates"
# Log directory for the site
LOG_DIR="/var/log/nginx"
# Path for Diffie-Hellman parameter file
DHPARAM_PATH="/etc/nginx/dhparam.pem"

# --- R-Studio and Web Services Ports ---
RSTUDIO_PORT="8787"
WEB_TERMINAL_PORT="2222"
NEXTCLOUD_TARGET_URL="https://192.168.1.100"

# --- Self-Signed Certificate Details ---
SSL_CERT_DIR="/etc/nginx/ssl"
SSL_DAYS="365"
SSL_COUNTRY="US"
SSL_STATE="New York"
SSL_LOCALITY="New York"
SSL_ORGANIZATION="Global Tech"
SSL_ORG_UNIT="IT Department"

# --- Let's Encrypt Details ---
LE_EMAIL="your-email@example.com"
LE_CERT_DIR="/etc/letsencrypt/live"
# Let's Encrypt Mode: "PRODUCTION" for real certs, "STAGING" for testing (no rate limits)
LE_MODE="PRODUCTION"
# Additional domains for the certificate (comma-separated, auto-detected from AD if joined)
LE_ADDITIONAL_DOMAINS=""
# Webroot path for HTTP-01 challenge validation
LE_WEBROOT="/var/www/html"

# =============================================================================
# AUTHENTICATION BACKEND CONFIGURATION
# =============================================================================
# Choose authentication backend for Nginx PAM integration:
# "SSSD"  - SSSD + Kerberos (recommended for caching, reduced AD load)
# "SAMBA" - Samba + Kerberos (for SMB shares, direct AD auth)
AUTH_BACKEND="SSSD"

# =============================================================================
# AD/KERBEROS SETTINGS (derived from common config with fallbacks)
# =============================================================================
# These use values from lib_kerberos_setup.vars.conf if available
AD_DOMAIN_LOWER="${DEFAULT_AD_DOMAIN_LOWER:-example.com}"
AD_DOMAIN_UPPER="${DEFAULT_AD_DOMAIN_UPPER:-EXAMPLE.COM}"
AD_REALM="${AD_DOMAIN_UPPER}"

# =============================================================================
# SSSD-SPECIFIC CONFIGURATION (used if AUTH_BACKEND="SSSD")
# =============================================================================
SSSD_CONFIG_DIR="/etc/sssd"
SSSD_DB_DIR="/var/lib/sss/db"
# Uses common allowed groups from lib_kerberos_setup.vars.conf
SSSD_ALLOWED_GROUPS="${DEFAULT_SIMPLE_ALLOW_GROUPS:-}"
SSSD_CACHE_TIMEOUT="3600"

# =============================================================================
# SAMBA/WINBIND-SPECIFIC CONFIGURATION (used if AUTH_BACKEND="SAMBA")
# =============================================================================
# Config path from join_domain_samba.vars.conf or default
SAMBA_CONFIG_PATH="${DEFAULT_SAMBA_SMB_CONF_PATH:-/etc/samba/smb.conf}"
SAMBA_LOG_LEVEL="${DEFAULT_SAMBA_LOG_LEVEL:-1}"
SAMBA_MAX_LOG_SIZE="${DEFAULT_SAMBA_MAX_LOG_SIZE:-50}"
# ID mapping ranges from join_domain_samba.vars.conf
IDMAP_RANGE_LOW="${DEFAULT_IDMAP_STAR_RANGE_LOW:-10000}"
IDMAP_RANGE_HIGH="${DEFAULT_IDMAP_STAR_RANGE_HIGH:-999999}"
# Home directory template from common config
TEMPLATE_HOMEDIR="${DEFAULT_HOME_TEMPLATE:-/nfs/home/%U}"
# Workgroup from join_domain_samba.vars.conf or derived
SAMBA_WORKGROUP="${DEFAULT_WORKGROUP:-WORKGROUP}"
# Uses common allowed groups
SAMBA_ALLOWED_GROUPS="${DEFAULT_SIMPLE_ALLOW_GROUPS:-}"

# =============================================================================
# PAM NGINX SERVICE CONFIGURATION
# =============================================================================
PAM_NGINX_SERVICE_NAME="nginx"
PAM_AUTH_MESSAGE="Secure Area - Active Directory Credentials Required"

# =============================================================================
# OPTIONAL AD SETTINGS
# =============================================================================
AD_ADMIN_USER=""
COMPUTER_OU=""
SSH_PORT="22"
